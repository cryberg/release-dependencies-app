<!DOCTYPE html>
<html>
<head>
    <title>Random App Name60335</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"exportBtn",cls:"export-button"},{xtype:"container",itemId:"comboboxContainer",cls:"combo-box"},{xtype:"container",itemId:"iterationComboboxContainer",cls:"combo-box"},{xtype:"container",itemId:"submitButton",cls:"submit-button"},{xtype:"container",itemId:"gridContainer"}],launch:function(){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Loading data..."}),this._myMask.show(),this.down("#comboboxContainer").add({xtype:"rallyreleasecombobox",itemId:"stateComboBox",allowNoEntry:!0,noEntryText:"All Releases",value:2,model:"userstory",stateful:!0,stateId:this.getContext().getScopedStateId("release"),listeners:{scope:this}}),this.down("#comboboxContainer").add({xtype:"rallyiterationcombobox",itemId:"iterationComboBox",allowNoEntry:!0,noEntryText:"All Iterations",model:"userstory",stateful:!0,stateId:this.getContext().getScopedStateId("iteration"),listeners:{scope:this,ready:this._initStore}}),this.down("#submitButton").add({text:"Filter Stories",xtype:"button",listeners:{click:this._submitFilter,scope:this}})},_getStateFilter:function(){var Dependencies=Rally.data.QueryFilter.or([{property:"Predecessors.ObjectID",operator:"!=",value:null},{property:"Successors.ObjectID",operator:"!=",value:null}]),iterationFilter,releaseFilter;return"All Iterations"!==this.down("#iterationComboBox").getRawValue()&&(iterationFilter={property:"Iteration.Name",operator:"=",value:this.down("#iterationComboBox").getRawValue().split(" (")[0]}),"All Releases"!==this.down("#stateComboBox").getRawValue()&&(releaseFilter={property:"Release.Name",operator:"=",value:this.down("#stateComboBox").getRawValue().split(" (")[0]}),releaseFilter||iterationFilter?releaseFilter&&iterationFilter?Dependencies.and(Ext.create("Rally.data.QueryFilter",releaseFilter)).and(Ext.create("Rally.data.QueryFilter",iterationFilter)):!releaseFilter&&iterationFilter?Dependencies.and(Ext.create("Rally.data.QueryFilter",iterationFilter)):Dependencies.and(Ext.create("Rally.data.QueryFilter",releaseFilter)):Dependencies},_submitFilter:function(){var store=this._store;store.clearFilter(!0),this._myMask.show(),store.filter(this._getStateFilter())},_initStore:function(){var scope=this;this._store=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",autoLoad:!0,remoteSort:!1,fetch:["FormattedID","Name","Project","Release","Feature","Milestones","ScheduleState","Successors","Iteration","DueDate","Predecessors"],filters:[this._getStateFilter()],limit:1/0,listeners:{load:this._onDataLoaded,scope:this}})},_onDataLoaded:function(store,data){if(0===data.length)return this._makeGrid(data),void 0;var stories=new Map,promises=[],self=this;_.each(data,function(story){var s={Feature:story.get("Feature"),FormattedID:story.get("FormattedID"),StoryNumericID:Number(story.get("FormattedID").replace(/\D+/g,"")),Name:story.get("Name"),Project:story.get("Project")?story.get("Project").Name:"",Release:story.get("Release")?story.get("Release").Name:"",_ref:story.get("_ref"),Predecessor:{},PredName:"",PredNumericID:"",PredProject:"",PredScheduleState:"",PredIteration:"",PredIterationSortNum:0,PredDueDate:null,Successor:{},SuccName:"",SuccNumericID:"",SuccProject:"",SuccScheduleState:"",SuccIteration:"",SuccIterationSortNum:0,StoryScheduleState:story.get("ScheduleState"),Iteration:story.get("Iteration")?story.get("Iteration").Name:"",DueDate:story.get("DueDate")};s.Feature&&(s.FeatureName=s.Feature.Name,s.FeatureNumericID=Number(s.Feature.FormattedID.replace(/\D+/g,""))),s.IterationSortNumber=this._getSortableIteration(s.Iteration);var predecessorsStore=story.getCollection("Predecessors"),predecessorPromise=predecessorsStore.load({fetch:["FormattedID","Name","Project","ScheduleState","Iteration","DueDate"]}),successorsStore=story.getCollection("Successors"),successorPromise=successorsStore.load({fetch:["FormattedID","Name","Project","ScheduleState","Iteration"]});promises.push(predecessorPromise,successorPromise),story.PredecessorsStore=predecessorsStore,story.SuccessorsStore=successorsStore,stories.set(s.FormattedID,s)},this),Deft.Promise.all(promises).then({success:function(){_.each(data,function(story){var storyDuplicationArray=[],predecessorsArray=story.PredecessorsStore.getRange();_.each(predecessorsArray,function(predecessor){var s=JSON.parse(JSON.stringify(stories.get(story.get("FormattedID")))),iteration=predecessor.get("Iteration")?predecessor.get("Iteration").Name:"";s.Predecessor={_ref:predecessor.get("_ref"),FormattedID:predecessor.get("FormattedID")},s.PredName=predecessor.get("Name"),s.PredNumericID=Number(s.Predecessor.FormattedID.replace(/\D+/g,"")),s.PredProject=predecessor.get("Project")?predecessor.get("Project").Name:"",s.PredScheduleState=predecessor.get("ScheduleState"),s.PredIteration=iteration,s.PredIterationSortNum=self._getSortableIteration(iteration),s.PredDueDate=predecessor.get("DueDate"),storyDuplicationArray.push(s)});var successorsArray=story.SuccessorsStore.getRange();_.each(successorsArray,function(successor){var s=JSON.parse(JSON.stringify(stories.get(story.get("FormattedID")))),iteration=successor.get("Iteration")?successor.get("Iteration").Name:"";s.Successor={_ref:successor.get("_ref"),FormattedID:successor.get("FormattedID")},s.SuccName=successor.get("Name"),s.SuccNumericID=Number(s.Successor.FormattedID.replace(/\D+/g,"")),s.SuccProject=successor.get("Project")?successor.get("Project").Name:"",s.SuccScheduleState=successor.get("ScheduleState"),s.SuccIteration=iteration,s.SuccIterationSortNum=self._getSortableIteration(iteration),storyDuplicationArray.push(s)}),0!==storyDuplicationArray.length&&stories.set(story.get("FormattedID"),storyDuplicationArray)});var storiesArray=this._getStoriesArray(stories);this._makeGrid(storiesArray)},scope:this})},_getSortableIteration:function(_iterationStr){if(_iterationStr){var iterationStr=_iterationStr.split(" ")[1],iterationDecimal=iterationStr.split(".")[1].charCodeAt(0)-64;return iterationStr=iterationStr.split(".")[0]+"."+iterationDecimal,Number(iterationStr)}return 0},_getStoriesArray:function(storiesMap){var storiesArray=[];return storiesMap.forEach(function(value,key){Array.isArray(value)?_.each(value,function(storyItem){storiesArray.push(storyItem)}):storiesArray.push(value)},storiesMap),storiesArray},_makeGrid:function(stories){this._myMask.hide(),this._stories=stories;var store=Ext.create("Rally.data.custom.Store",{data:stories,sorters:[{property:"IterationSortNumber",direction:"DESC"},{property:"Project",direction:"ASC"}],proxy:{type:"memory"}});this._grid?this._grid.reconfigure(store):(this._grid=Ext.create("Rally.ui.grid.Grid",{itemId:"storiesGrid",store:store,showRowActionsColumn:!1,showPagingToolbar:!1,columnCfgs:[{text:"Predecessor ID",dataIndex:"Predecessor",tdCls:"grey-background",width:75,align:"center",getSortParam:function(){return"PredNumericID"},renderer:function(value,meta){return meta.tdCls="grey-background",value.FormattedID?'<a href="'+Rally.nav.Manager.getDetailUrl(value)+'" target="_blank">'+value.FormattedID+"</a>":void 0}},{text:"Predecessor Name",dataIndex:"PredName",tdCls:"grey-background",width:175},{text:"Predecessor Project",dataIndex:"PredProject",tdCls:"grey-background"},{text:"Predecessor State",dataIndex:"PredScheduleState",tdCls:"grey-background",width:75},{text:"Predecessor Iteration",dataIndex:"PredIteration",tdCls:"grey-background",width:70,getSortParam:function(){return"PredIterationSortNum"}},{text:"Predecessor Due Date",dataIndex:"PredDueDate",tdCls:"grey-background",xtype:"datecolumn",format:"D n/j/Y",width:75},{text:"Story ID",dataIndex:"FormattedID",xtype:"templatecolumn",width:75,tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate"),getSortParam:function(){return"StoryNumericID"}},{text:"Story Name",dataIndex:"Name",width:175},{text:"Story Project",dataIndex:"Project"},{text:"Story State",dataIndex:"StoryScheduleState",width:75},{text:"Release",dataIndex:"Release"},{text:"Story Iteration",dataIndex:"Iteration",width:70,getSortParam:function(){return"IterationSortNumber"}},{text:"Story Due Date",dataIndex:"DueDate",xtype:"datecolumn",format:"D n/j/Y",width:75},{text:"Feature ID",dataIndex:"Feature",width:65,align:"center",getSortParam:function(){return"FeatureNumericID"},renderer:function(value){return value?'<a href="'+Rally.nav.Manager.getDetailUrl(value)+'" target="_blank">'+value.FormattedID+"</a>":void 0}},{text:"Feature Name",dataIndex:"FeatureName",width:175},{text:"Successor ID",dataIndex:"Successor",tdCls:"grey-background",width:75,align:"center",getSortParam:function(){return"SuccNumericID"},renderer:function(value){return value.FormattedID?'<a href="'+Rally.nav.Manager.getDetailUrl(value)+'" target="_blank">'+value.FormattedID+"</a>":void 0}},{text:"Successor Name",dataIndex:"SuccName",tdCls:"grey-background",width:175},{text:"Successor Project",dataIndex:"SuccProject",tdCls:"grey-background"},{text:"Successor State",dataIndex:"SuccScheduleState",tdCls:"grey-background",width:75},{text:"Successor Iteration",dataIndex:"SuccIteration",tdCls:"grey-background",width:70,getSortParam:function(){return"SuccIterationSortNum"}}]}),this.down("#gridContainer").add(this._grid),this.down("#exportBtn").add({xtype:"rallybutton",text:"Export to CSV",href:"data:text/csv;charset=utf8,"+encodeURIComponent(this._getCSV()),id:"exportButton",scope:this}),document.getElementById("exportButton").setAttribute("download","export.csv"))},_onClickExport:function(){var data=this._getCSV();window.location="data:text/csv;charset=utf8,"+encodeURIComponent(data)},_getCSV:function(){var cols=this._grid.columns,data="";return _.each(cols,function(col,index){data+=this._getFieldTextAndEscape(col.text)+","},this),data+="\r\n",_.each(this._stories,function(record){_.each(cols,function(col,index){var text="",fieldName=col.dataIndex;text="Predecessor"!==fieldName&&"Successor"!==fieldName&&"Feature"!==fieldName||!record[fieldName]?-1!==fieldName.indexOf("DueDate")&&record[fieldName]?"string"==typeof record[fieldName]?record[fieldName].split("T")[0]:Ext.Date.format(record[fieldName],"Y-m-d"):record[fieldName]:record[fieldName].FormattedID,data+=this._getFieldTextAndEscape(text)+","},this),data+="\r\n"},this),data},_getFieldTextAndEscape:function(fieldData){var string=this._getFieldText(fieldData);return this._escapeForCSV(string)},_getFieldText:function(fieldData){var text;return text=null!==fieldData&&void 0!==fieldData&&fieldData.match?fieldData._refObjectName?fieldData._refObjectName:fieldData:""},_escapeForCSV:function(string){return string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name60335",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        tr:not(.x-grid-row-over):not(.x-grid-row-selected) .grey-background{background:#eff0f1 !important}.export-button,.export-button>span,.submit-button,.submit-button>span,.combo-box,.combo-box>span,.combo-box>span>div>table{display:inline-block !important}.combo-box>span>div{display:inline}.combo-box table.rally-release-combobox,.combo-box table.rally-iteration-combobox{margin-bottom:0;margin-top:5px}.x-panel-body{height:auto !important}
    </style>
</head>
<body>
</body>
</html>
