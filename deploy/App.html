<!DOCTYPE html>
<html>
<head>
    <title>Random App Name60335</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"exportBtn",cls:"export-button"},{xtype:"container",itemId:"milestoneCombobox",cls:"milestone-combo-box"},{xtype:"container",itemId:"gridContainer"}],launch:function(){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Loading data..."}),this._myMask.show(),this.down("#milestoneCombobox").add({xtype:"rallymilestonecombobox",itemId:"stateComboBox",allowNoEntry:!0,model:["userstory"],listeners:{scope:this,select:this._onSelect,ready:this._initStore}})},_getStateFilter:function(){return{property:"FeatureMilestones",operator:"=",value:this.down("#stateComboBox").getRawValue()}},_onSelect:function(){var store=this._grid.getStore();store.clearFilter(!0),"-- No Entry --"!==this.down("#stateComboBox").getRawValue()?store.filter(this._getStateFilter()):store.reload()},_initStore:function(){Ext.create("Rally.data.wsapi.Store",{model:"UserStory",autoLoad:!0,remoteSort:!1,fetch:["FormattedID","Name","Project","Release","Feature","Milestones","ScheduleState","Successors","Iteration","DueDate"],limit:1/0,listeners:{load:this._onDataLoaded,scope:this}}),this._featureStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem",autoLoad:!0,remoteSort:!1,fetch:["FormattedID","State"],limit:1/0})},_onDataLoaded:function(store,data){var stories=[],pendingPredecessors=data.length,pendingSuccessors=data.length;_.each(data,function(story){var s={Feature:story.get("Feature"),FormattedID:story.get("FormattedID"),StoryNumericID:Number(story.get("FormattedID").replace(/\D+/g,"")),Name:story.get("Name"),Project:story.get("Project")?story.get("Project").Name:"",Release:story.get("Release")?story.get("Release").Name:"",_ref:story.get("_ref"),Predecessors:[],Successors:[],StoryScheduleState:story.get("ScheduleState"),Iteration:story.get("Iteration")?story.get("Iteration").Name:"",DueDate:story.get("DueDate")};s.Feature&&(s.FeatureName=s.Feature.Name,s.FeatureNumericID=Number(s.Feature.FormattedID.replace(/\D+/g,"")));var predecessors=story.getCollection("Predecessors",{fetch:["FormattedID","Name","Project","ScheduleState","Iteration","DueDate"]});predecessors.load({callback:function(records){_.each(records,function(predecessor){s.Predecessors.push({_ref:predecessor.get("_ref"),FormattedID:predecessor.get("FormattedID"),Name:predecessor.get("Name"),Project:predecessor.get("Project")?predecessor.get("Project").Name:"",ScheduleState:predecessor.get("ScheduleState"),Iteration:predecessor.get("Iteration")?predecessor.get("Iteration").Name:"",DueDate:predecessor.get("DueDate")})},this),--pendingPredecessors},scope:this});var successors=story.getCollection("Successors",{fetch:["FormattedID","Name","Project","ScheduleState","Iteration","DueDate"]});successors.load({callback:function(records){_.each(records,function(successor){s.Successors.push({_ref:successor.get("_ref"),FormattedID:successor.get("FormattedID"),Name:successor.get("Name"),Project:successor.get("Project")?successor.get("Project").Name:"",ScheduleState:successor.get("ScheduleState"),Iteration:successor.get("Iteration")?successor.get("Iteration").Name:""})},this),--pendingSuccessors,0===pendingSuccessors&&this._makeGrid(stories)},scope:this}),stories.push(s)},this)},_makeGrid:function(stories){this._myMask.hide();var store=Ext.create("Rally.data.custom.Store",{data:stories,proxy:{type:"memory"}});this._stories=stories,this._grid=Ext.create("Rally.ui.grid.Grid",{itemId:"storiesGrid",store:store,showRowActionsColumn:!1,showPagingToolbar:!1,columnCfgs:[{text:"Predecessor ID",dataIndex:"Predecessors",renderer:function(value){return value[0]?value[0].FormattedID:void 0}},{text:"Predecessor Name",dataIndex:"Predecessors",renderer:function(value){return value[0]?value[0].Name:void 0}},{text:"Predecessor Project",dataIndex:"Predecessors",renderer:function(value){return value[0]?value[0].Project:void 0}},{text:"Predecessor Schedule State",dataIndex:"Predecessors",renderer:function(value){return value[0]?value[0].ScheduleState:void 0}},{text:"Predecessor Iteration",dataIndex:"Predecessors",renderer:function(value){return value[0]?value[0].Iteration:void 0}},{text:"Predecessor Due Date",dataIndex:"Predecessors",renderer:function(value){return value[0]?value[0].DueDate:void 0}},{text:"Story ID",dataIndex:"FormattedID",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate"),getSortParam:function(){return"StoryNumericID"}},{text:"Story Name",dataIndex:"Name",flex:1},{text:"Story Project",dataIndex:"Project"},{text:"Story Schedule State",dataIndex:"StoryScheduleState"},{text:"Story Iteration",dataIndex:"Iteration"},{text:"Story Due Date",dataIndex:"DueDate"},{text:"Feature ID",dataIndex:"Feature",width:65,getSortParam:function(){return"FeatureNumericID"},renderer:function(value){return value?'<a href="'+Rally.nav.Manager.getDetailUrl(value)+'">'+value.FormattedID+"</a>":void 0}},{text:"Feature Name",dataIndex:"FeatureName",flex:1},{text:"Successor ID",dataIndex:"Successors",renderer:function(value){return value[0]?value[0].FormattedID:void 0}},{text:"Successor Name",dataIndex:"Successors",renderer:function(value){return value[0]?value[0].Name:void 0}},{text:"Successor Project",dataIndex:"Successors",renderer:function(value){return value[0]?value[0].Project:void 0}},{text:"Successor Schedule State",dataIndex:"Successors",renderer:function(value){return value[0]?value[0].ScheduleState:void 0}},{text:"Successor Iteration",dataIndex:"Successors",renderer:function(value){return value[0]?value[0].Iteration:void 0}}]}),this.down("#gridContainer").add(this._grid),this.down("#exportBtn").add({xtype:"rallybutton",text:"Export to CSV",handler:this._onClickExport,scope:this})},_onClickExport:function(){var data=this._getCSV();window.location="data:text/csv;charset=utf8,"+encodeURIComponent(data)},_getCSV:function(){var cols=this._grid.columns,data="";return _.each(cols,function(col){data+=this._getFieldTextAndEscape(col.text)+","},this),data+="Milestones,",data+="\r\n",_.each(this._stories,function(record){var featureData=record.Feature,storyData="";_.each(cols,function(col){var text="",fieldName=col.dataIndex;"Feature"===fieldName&&featureData?text=featureData.FormattedID:"TestCaseCount"===fieldName?text=""+record[fieldName]:"TestCases"===fieldName?data+=this._getTestCaseRowsForCSV(record[fieldName],storyData,record.TestCaseCount,featureData):text=record[fieldName];var cleanText=this._getFieldTextAndEscape(text);data+=cleanText+",",storyData+=cleanText+","},this),data+=this._getMilestonesForCSV(featureData),data+="\r\n"},this),data},_getMilestonesForCSV:function(feature){var milestones="";return _.each(feature.Milestones._tagsNameArray,function(milestone){milestones+=this._getFieldTextAndEscape(milestone.Name)+" "},this),milestones},_getTestCaseRowsForCSV:function(testcases,storyRowStr,testcaseCount,feature){var self=this,testcaseRows="";return _.each(testcases,function(testcase,index){testcaseRows+=0===index?self._getFieldTextAndEscape(testcase.FormattedID):storyRowStr+self._getFieldTextAndEscape(testcase.FormattedID),testcaseCount>1&&index!==testcaseCount-1&&(testcaseRows+=","+self._getMilestonesForCSV(feature)+"\r\n")}),testcaseRows},_getFieldTextAndEscape:function(fieldData){var string=this._getFieldText(fieldData);return this._escapeForCSV(string)},_getFieldText:function(fieldData){var text;return text=null!==fieldData&&void 0!==fieldData&&fieldData.match?fieldData._refObjectName?fieldData._refObjectName:fieldData:""},_escapeForCSV:function(string){return string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name60335",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
